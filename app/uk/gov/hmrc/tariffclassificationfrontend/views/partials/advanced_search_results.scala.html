@*
 * Copyright 2019 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.tariffclassificationfrontend.config.AppConfig
@import uk.gov.hmrc.tariffclassificationfrontend.controllers.routes
@import uk.gov.hmrc.tariffclassificationfrontend.models.AppealStatus.AppealStatus
@import uk.gov.hmrc.tariffclassificationfrontend.models.CaseStatus.CaseStatus
@import uk.gov.hmrc.tariffclassificationfrontend.models.ReviewStatus.ReviewStatus
@import uk.gov.hmrc.tariffclassificationfrontend.models.{AppealStatus, CancelReason, Case, CaseStatus, Paged, ReviewStatus}
@import uk.gov.hmrc.tariffclassificationfrontend.utils.Dates
@import uk.gov.hmrc.tariffclassificationfrontend.models.StoredAttachment
@import uk.gov.hmrc.tariffclassificationfrontend.views.partials.SearchResult
@import uk.gov.hmrc.tariffclassificationfrontend.models.response.ScanStatus
@(results: Paged[SearchResult])(implicit request: Request[_], messages: Messages, appConfig: AppConfig)

<div id="advanced_search_results">
  @for((result: SearchResult, index: Int) <- results.results.zipWithIndex) {
   <div id="advanced_search_results-row-@index" class="advanced_search_results--row">

    <div class="grid-row">
     <div class="column-one-half">
      @*Reference*@
      <div>
       <a id="advanced_search_results-row-@{index}-reference" href="@routes.CaseController.trader(result.c.reference)">@result.c.reference</a>
      </div>

      @*Trader*@
      <div>
       <span class="bold">Trader:</span>
       <span id="advanced_search_results-row-@{index}-business_name">@result.c.application.holder.businessName</span>
      </div>

      @*Expiry*@
      <div>
       <span class="bold">Expiry date:</span>
       <span id="advanced_search_results-row-@{index}-ruling_end">@result.c.decision.flatMap(_.effectiveEndDate).map(Dates.format).getOrElse("TBC")</span>
      </div>
     </div>

     <div class="column-one-half align-right">
      @*Commodity Code*@
      <div>
       <span class="bold">Commodity code:</span>
       <span id="advanced_search_results-row-@{index}-decision_code">
        @result.c.decision.map(_.bindingCommodityCode).getOrElse("TBC")
       </span>
      </div>

      @*Status*@
      <div>
       <span class="bold">Status:</span>
       <span id="advanced_search_results-row-@{index}-status" class="phase-tag bg-blue">
       @result.c.status match {
        case CaseStatus.CANCELLED if result.c.decision.exists(_.cancellation.isDefined) => {
         CANCELLED - @{result.c.decision.flatMap(_.cancellation).map(c => CancelReason.code(c.reason)).get}
        }
        case s : CaseStatus => {@s}
       }
       </span>
       @defining(result.c.decision.flatMap(_.review).map(_.status)) { status: Option[ReviewStatus] =>
        @if(status.isDefined) {
         <span id ="advanced_search_results-row-@{index}-review_status" class="phase-tag bg-red">@ReviewStatus.format(status)</span>
        }
       }

       @defining(result.c.decision.flatMap(_.appeal).map(_.status)) { status: Option[AppealStatus] =>
        @if(status.isDefined) {
         <span id ="advanced_search_results-row-@{index}-appeal_status" class="phase-tag bg-red">@AppealStatus.format(status)</span>
        }
       }
      </div>
     </div>
    </div>

    @*Keywords*@
    <div>
     <span class="bold">Keywords:</span>
     <span id="advanced_search_results-row-@{index}-keywords">@result.c.keywords.mkString(", ")</span>
    </div>

    @defining(result.attachments.filter(att => att.scanStatus.contains(ScanStatus.READY) && att.url.isDefined && att.isImage)) { attachments: Seq[StoredAttachment] =>
     @if(attachments.nonEmpty) {
      <div id="advanced_search_results-row-@{index}-attachments" class="mt-1">
       @for((attachment: StoredAttachment, attIndex: Int) <- attachments.zipWithIndex) {
        <img id="advanced_search_results-row-@{index}-attachments-@{attIndex}" src="@attachment.url" class="advanced_search_results--thumbnail" alt="@attachment.fileName"/>
       }
      </div>
     }
    }

   </div>
  }

  @if(results.isEmpty) {
   <p id="advanced_search_results-empty" class="mt-1">No results found</p>
  }
</div>

