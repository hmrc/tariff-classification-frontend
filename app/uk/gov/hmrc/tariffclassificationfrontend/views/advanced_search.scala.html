@*
 * Copyright 2019 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.tariffclassificationfrontend.config.AppConfig
@import uk.gov.hmrc.tariffclassificationfrontend.controllers
@import uk.gov.hmrc.tariffclassificationfrontend.controllers.SessionKeys
@import uk.gov.hmrc.tariffclassificationfrontend.models.PseudoCaseStatus.PseudoCaseStatus
@import uk.gov.hmrc.tariffclassificationfrontend.models.{Paged, PseudoCaseStatus, Search}
@import uk.gov.hmrc.tariffclassificationfrontend.views.forms.components.CheckOption
@import uk.gov.hmrc.tariffclassificationfrontend.views.html.forms.components.{input_checkbox_group, input_text}
@import uk.gov.hmrc.tariffclassificationfrontend.views.html.includes.main
@import uk.gov.hmrc.tariffclassificationfrontend.views.html.partials.{advanced_search_keywords, advanced_search_results, back_link, pagination}
@import uk.gov.hmrc.tariffclassificationfrontend.views.partials.SearchResult
@(form: Form[Search], results: Option[Paged[SearchResult]] = None, keywords: Seq[String])(implicit request: Request[_], messages: Messages, appConfig: AppConfig)

@formHasStatus(status: PseudoCaseStatus) = @{
 form.value.flatMap(_.status).exists(_.contains(status))
}

@main(bodyClasses = None) {

 @back_link(displayBackLink = true, SessionKeys.backToQueuesLinkUrl, SessionKeys.backToQueuesLinkLabel)

 <h1 id="advanced_search-heading" class="heading-xlarge">Advanced search</h1>

 <h2 class="heading-large">Enter search terms</h2>
 <hr class="mt-0"/>

 @helper.form(action = controllers.routes.SearchController.search(), 'id -> "advanced_search-form") {
  @input_text(
   field = form("trader_name"),
   label = "Trader name",
   formControlClass = Some("w-75")
  )

  @input_text(
   field = form("commodity_code"),
   label = "Commodity code",
   formControlClass = Some("w-75")
  )

  @input_text(
   field = form("decision_details"),
   label = "Ruling details",
   hint = Some("Search the goods description, justification and the commercial denomination"),
   formControlClass = Some("w-75")
  )

  @advanced_search_keywords(form, keywords)


  <button id="advanced_search-search_button" class="button" type="submit">Search</button>
  <a id="advanced_search-reset_button" class="secondary-button" href="@controllers.routes.SearchController.search()">New search</a>

  @if(results.isEmpty) {
   @*
    Hack to ensure the checkbox is checked when search results aren't present
    This is only required for form elements that are rendered when results are present and which need a default value.
   *@
      <input type="hidden" value="OPEN" name="status[0]"/>
      <input type="hidden" value="LIVE" name="status[1]"/>
  }

  @if(results.isDefined && !form.hasErrors) {
   <div id="advanced_search-results_and_filters" class="mt-3">

    <h2 class="heading-large">Search Results</h2>

    <div class="grid-row">
     <div class="column-one-quarter">
      <p>Filter your results:</p>

      <div class="advanced_search--filters_container">
       <div class="advanced_search--filters_heading">
        Filter by case status
       </div>
       <div class="advanced_search--filters">
        @input_checkbox_group(
         field = form("status"),
         options = Seq(
          CheckOption("Open", PseudoCaseStatus.OPEN.toString, checked = formHasStatus(PseudoCaseStatus.OPEN)),
          CheckOption("Completed", PseudoCaseStatus.LIVE.toString, checked = formHasStatus(PseudoCaseStatus.LIVE)),
          CheckOption("Expired", PseudoCaseStatus.EXPIRED.toString, checked = formHasStatus(PseudoCaseStatus.EXPIRED)),
          CheckOption("Cancelled", PseudoCaseStatus.CANCELLED.toString, checked = formHasStatus(PseudoCaseStatus.CANCELLED)),
          CheckOption("New", PseudoCaseStatus.NEW.toString, checked = formHasStatus(PseudoCaseStatus.NEW)),
          CheckOption("Referred", PseudoCaseStatus.REFERRED.toString, checked = formHasStatus(PseudoCaseStatus.REFERRED)),
          CheckOption("Suspended", PseudoCaseStatus.SUSPENDED.toString, checked = formHasStatus(PseudoCaseStatus.SUSPENDED)),
          CheckOption("Rejected", PseudoCaseStatus.REJECTED.toString, checked = formHasStatus(PseudoCaseStatus.REJECTED)),
          CheckOption("Suppressed", PseudoCaseStatus.SUPPRESSED.toString, checked = formHasStatus(PseudoCaseStatus.SUPPRESSED))
         ),
         submitOnChange = true
        )
       </div>
      </div>
     </div>


     @defining(results.get) { searchResults: Paged[SearchResult] =>
      <div class="column-three-quarters">

       @pagination(
        id = "advanced_search-pagination_top",
        singularName = "case",
        pluralName = "cases",
        pager = searchResults,
        containerClass = Some("mb-1"),
        onChange = page => controllers.routes.SearchController.search(search = form.get, page = page)
       )

       @advanced_search_results(searchResults)

       @pagination(
        id = "advanced_search-pagination_bottom",
        singularName = "case",
        pluralName = "cases",
        pager = searchResults,
        containerClass = Some("mt-30"),
        onChange = page => controllers.routes.SearchController.search(search = form.get, page = page)
       )

      </div>
     }
    </div>

   </div>
  }
 }

}
